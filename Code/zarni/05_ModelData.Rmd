---
title: "R Notebook"
output:
  html_notebook: default
  pdf_document: default
---
Libraries

```{r, warning = FALSE}
library(readxl)
library(data.table)
library(lubridate) #Date Time Object
library(ggplot2)
library(stringr) #Regular expression string splitting
library(rio)
library(MASS)
library(tigris)
library(sp)
library(broom)
library(dplyr)
library(rgdal)
library(stargazer)
library(stats) #Principal Component Package
library(lme4)
library(lmerTest)
```

T21 External Raw Data 
```{r}
T21External <- import("../../Data/MACTownHealth21_v6.csv")
View(T21External)
```

Remove the 2 cases and remove the years before 2009 and removing 2018 (Data needs to be reformatted again)
```{r}
T21ExtSub <- T21External[T21External$Event != 2, ]
T21ExtSub <- T21ExtSub[-1]
T21ExtSub <- subset(T21ExtSub, Year > 2010)
T21ExtSub <- subset(T21ExtSub, Year < 2018)
View(T21ExtSub)

write.csv(T21ExtSub, "../../Data/T21ExtSub.csv")
View(T21ExtSub)
```

All T21 Imports

```{r}
AllT21TopRatios <- import("../../Data/AllT21TopRatios.csv")
View(AllT21TopRatios)
AllT21TopRatios <- AllT21TopRatios[-1]
View(AllT21TopRatios)
```

Merging the data file
```{r}
T21Merged <- T21ExtSub %>% left_join(AllT21TopRatios, by = c("Name" ="CityTown", "Year" = "year"))
```

```{r}
names(T21Merged) <- gsub(" ","",names(T21Merged))
```

```{r}
str(T21Merged)
T21Merged$Population <- as.numeric (T21Merged$Population)
write.csv(T21Merged, "../../Data/T21Mergedsecondattempt.csv")
```

```{r}
demo <- import("../../Data/T21Mergedsecondattempt.csv")
View(demo)
dim(demo)
```



```{r}
T21Merged$Event <- as.numeric(T21Merged$Event)
```



Logit Model
```{r}
logitmodel1 <- glm(Event ~  Population + NearbyT21Ratio + PhysicallyUnhealthyDays + MentallyUnhealthyDays + PercentSmokers + PercentExcessiveDrinking + TeenBirthRate + ChlamydiaRate + PercentUnemployed + ViolentCrimeRate   , family = binomial(link = "logit"), data = T21Merged )

summary(logitmodel1)
```

Table format
```{r}
stargazer(logitmodel, type = "text")

```

```{r}
exp(coefficients(logitmodel))
```
Should NearbyT21 Ratio be coded as a factor?

```{r}
T21Merged$FNT21Ratio <- as.factor(T21Merged$NearbyT21Ratio)
```

Logit Model 2
```{r}
logitmodel2 <- glm(Event ~  Population + FNT21Ratio + PhysicallyUnhealthyDays + MentallyUnhealthyDays + PercentSmokers + PercentExcessiveDrinking + TeenBirthRate + ChlamydiaRate + PercentUnemployed + ViolentCrimeRate   , family = binomial(link = "logit"), data = T21Merged )

summary(logitmodel2)
```


```{r}
stargazer(logitmodel2, type = "text")
```
```{r}
exp(coefficients(logitmodel2))
```

**Principal Component Analysis**


Principal Component Analysis

```{r}
pca_test <- T21Merged
```

```{r}
View(pca_test)
names(pca_test)
pca_test_01 <- pca_test[,c(7:36)]
```

What is the difference between using covariance matrix and correlation matrix?

```{r}
pca_job <- princomp(pca_test_01, cor = FALSE)
```

###Master File Latest Model Building

```{r}
master <- rio::import("../../Data/master.csv")
#View(master)
#names(master)
#Dropping Chlamydia Rate becasue we do NOT understand the measurement for now.
master <- subset(master, select = -c(25))
master <- master[,-c(1:2)]
View(master)
```

Getting the Top 10 ratios
```{r}
AllT21TopRatios <- import("../../Data/AllT21TopRatios.csv")
#View(AllT21TopRatios)
AllT21TopRatios <- AllT21TopRatios[-1]
#View(AllT21TopRatios)
```


Merging Ratios and the Master File
```{r}
T21_TopRatios_Master <- master %>% left_join(AllT21TopRatios, by = c("Name.x" ="CityTown", "year_dummy-2" = "year"))
names(T21_TopRatios_Master)[73] <- c("nearbyt21ratio")
```

```{r}
T21_TopRatios_Master <- T21_TopRatios_Master[T21_TopRatios_Master$Event !=2,]
T21_TopRatios_Master$Population <- as.numeric(T21_TopRatios_Master$Population)
sort(names(T21_TopRatios_Master))
```

Neighborhood Distance Function Method 1

```{r}
logitmodel_lag_21 <- glm(Event ~  Population + prct_r_2012 + prct_d_2012 + prct_d_2016 + prct_r_2016 + mayor_ind + nearbyt21ratio   , family = binomial(link = "logit"), data = T21_TopRatios_Master)
summary(logitmodel_lag_21)
```

Neighborhood Distance Function Method 2

Getting the distance based ratios
```{r}
AllT21ratios <- rio:: import("../../Data/AllT21Ratios.csv")
AllT21ratios <- AllT21ratios[-1]
```

```{r}
View(master)
T21_Ratios_Master <- master %>% left_join(AllT21ratios, by = c("Name.x" ="CityTown", "year_dummy-2" = "year"))
names(T21_Ratios_Master)[73] <- c("nearbyt21ratio")
```

```{r}
T21_Ratios_Master <- T21_Ratios_Master[T21_Ratios_Master$Event !=2,]
T21_Ratios_Master$Population <- as.numeric(T21_Ratios_Master$Population)
sort(names(T21_Ratios_Master))
```

Neighborhood Distance function Method 2
```{r}
logitmodel_lag_22 <- glm(Event ~  Population + prct_r_2012 + prct_d_2012 + prct_d_2016 + prct_r_2016 + mayor_ind + nearbyt21ratio   , family = binomial(link = "logit"), data = T21_Ratios_Master)
summary(logitmodel_lag_22)
```


Getting the Contigency based ratio which is already 1 year lagged

```{r}
AllT21ContigencyRatios <- rio::import("../../Data/borderratios.csv")
AllT21ContigencyRatios <- AllT21ContigencyRatios[-1]
```

```{r}
T21_Contingency_Master <- master %>% left_join(AllT21ContigencyRatios, by = c("Name.x" ="TownName", "Year" = "year"))
names(T21_Contingency_Master)[73] <- c("nearbyt21ratio")
```

```{r}
T21_Contnigency_Master <- T21_Contingency_Master[T21_Contingency_Master$Event !=2,]
T21_Contingency_Master$Population <- as.numeric(T21_Contingency_Master$Population)
sort(names(T21_Contingency_Master))
```


Neighborhood Contingency
```{r}
logitmodel_lag_23 <- glm(Event ~  Population + prct_r_2012 + prct_d_2012 + prct_d_2016 + prct_r_2016 + mayor_ind + nearbyt21ratio   , family = binomial(link = "logit"), data = T21_Contingency_Master)
summary(logitmodel_lag_23)
```








